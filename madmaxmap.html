<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mad Max | Mapnum Opus</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="map_locations.js"></script>

    <style>
        #map { height: 100vh; width: 100%; background: #050505; }
        .sidebar { 
            height: 100vh; 
            display: flex; 
            flex-direction: column;
            background: #121212; 
        }

        #route-list { 
            flex-grow: 1;
            overflow-y: auto; 
        }
        .active-step { border-left: 4px solid #f59e0b; background: #1f1f1f; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #f59e0b; }
        
        .leaflet-interactive { transition: stroke-dashoffset 0.5s ease; }

        .hud-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #71717a;
            transition: all 0.2s;
            border-radius: 2px;
            width: 100%;
            text-align: left;
        }

        .hud-btn:hover {
            color: #e4e4e7;
            background: rgba(255, 255, 255, 0.05);
        }

        .led {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #27272a;
            border: 1px solid #3f3f46;
        }

        .hud-btn.active-filter {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .hud-btn.active-filter .led {
            background: #f59e0b;
            border-color: #fbbf24;
            box-shadow: 0 0 8px #f59e0b;
        }

        #filter-hud {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
        }

        @keyframes hud-glitch {
            0% { transform: translate(0); opacity: 1; }
            20% { transform: translate(-2px, 1px); opacity: 0.8; }
            40% { transform: translate(2px, -1px); filter: contrast(150%) hue-rotate(90deg); }
            60% { transform: translate(-1px, 1px); opacity: 0.9; }
            100% { transform: translate(0); opacity: 1; }
        }
        .glitch-active { animation: hud-glitch 0.2s linear; }

        #region-hud .hud-btn.active-filter {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        #region-hud .hud-btn.active-filter .led {
            background: #3b82f6;
            border-color: #60a5fa;
            box-shadow: 0 0 8px #3b82f6;
        }

        #region-hud .hud-btn {
            padding: 4px 10px;
        }

        #region-list::-webkit-scrollbar { width: 2px; }
        #region-list::-webkit-scrollbar-thumb { background: #3b82f644; }
    </style>
</head>
<body class="flex bg-black text-gray-200 font-sans overflow-hidden">

    <div class="sidebar w-1/3 flex flex-col border-r border-gray-900" id="sidebar">
        <div class="p-6 border-b border-gray-800 bg-zinc-900/50">
            <h1 class="text-xl font-black text-orange-500 tracking-tighter uppercase italic">Max's Optimal Route Engine</h1>
            <p class="text-[10px] text-gray-500 uppercase font-bold tracking-[0.2em] mt-1">Mad Max Route Engine v0.3</p>
        </div>

        <div id="route-list" class="flex-grow overflow-y-auto"></div>

        <div id="route-stats" class="bg-zinc-900 border-t-2 border-orange-500/20 shadow-[0_-15px_40px_rgba(0,0,0,0.8)]">
            <div onclick="toggleStats()" class="flex justify-between items-center p-4 cursor-pointer hover:bg-white/5 transition-colors">
                <div class="flex items-center gap-3">
                    <span id="stats-chevron" class="text-orange-500 transition-transform duration-300">â–¼</span>
                    <span class="text-[10px] font-black text-orange-500 uppercase tracking-[0.4em]">Route Progress</span>
                </div>
                <span id="total-progress-percent" class="text-[10px] font-mono font-black text-orange-500/50">0% COMPLETE</span>
            </div>
            
            <div id="stats-content" class="max-h-[500px] overflow-hidden transition-all duration-500 ease-in-out px-6 pb-6">
                <div id="stats-container" class="grid grid-cols-3 gap-x-4 gap-y-6">
                    </div>
            </div>
        </div>

        <div class="p-3 bg-black border-t border-gray-800 text-center">
            <p class="text-[9px] text-gray-600 uppercase tracking-widest font-bold">Made by Plyd</p>
        </div>
    </div>

    <div class="w-2/3 relative h-screen">
        <div id="map"></div>
        <div id="coord-helper" class="absolute bottom-6 right-6 bg-black/90 p-3 text-[11px] text-orange-400 font-mono z-[1000] border border-orange-500/20 rounded-md shadow-2xl">
            Click map for pixel coordinates
        </div>
        <div class="absolute top-6 right-6 z-[1000] flex gap-2">
            <button onclick="toggleLines()" id="line-toggle-btn" 
                class="bg-black/80 border border-orange-500/50 text-orange-500 px-3 py-2 text-[10px] font-black uppercase tracking-widest hover:bg-orange-500 hover:text-black transition-all shadow-2xl rounded">
                Hide Overlay
            </button>
        </div>
        
        <div id="filter-hud" class="absolute bottom-24 left-6 z-[1000] flex flex-col gap-2 p-1 border border-orange-500/20 bg-black/80 backdrop-blur-sm shadow-2xl rounded-sm">
            <div class="px-2 py-1 border-b border-orange-500/10 mb-1 flex justify-between items-center">
                <span class="text-[8px] font-black text-orange-500/50 uppercase tracking-[0.3em]">Array Filters</span>
            </div>
            <div class="flex flex-col gap-1 w-32">
                <button onclick="applyFilter('all')" data-type="all" class="hud-btn active-filter"><div class="led"></div> <span>All Signals</span></button>
                <button onclick="applyFilter('stronghold')" data-type="stronghold" class="hud-btn"><div class="led"></div> <span>Strongholds</span></button>
                <button onclick="applyFilter('camp')" data-type="camp" class="hud-btn"><div class="led"></div> <span>Camps</span></button>
                <button onclick="applyFilter('scavloc')" data-type="scavloc" class="hud-btn"><div class="led"></div> <span>Scrap</span></button>
                <button onclick="applyFilter('minefield')" data-type="minefield" class="hud-btn"><div class="led"></div> <span>Mines</span></button>
                <button onclick="applyFilter('mission')" data-type="mission" class="hud-btn"><div class="led"></div> <span>Missions</span></button>
            </div>
        </div>

        <div id="region-hud" class="absolute bottom-24 left-44 z-[1000] flex flex-col gap-2 p-1 border border-blue-500/20 bg-black/80 backdrop-blur-sm shadow-2xl rounded-sm">
            <div class="px-2 py-1 border-b border-blue-500/10 mb-1">
                <span class="text-[8px] font-black text-blue-400/50 uppercase tracking-[0.3em]">Territory Scanner</span>
            </div>
            <div id="region-list" class="flex flex-col gap-0.5 w-40 max-h-64 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const icons = {
            stronghold: L.icon({ 
                iconUrl: 'icons/stronghold_temp.png', 
                iconSize: [32, 32], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            hideout: L.icon({ 
                iconUrl: 'icons/hideout.png', 
                iconSize: [24, 24], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            gastown: L.icon({ 
                iconUrl: 'icons/gastown.png', 
                iconSize: [24, 24], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            camp: L.icon({ 
                iconUrl: 'icons/transfertankcamp.png', 
                iconSize: [24, 24], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            scavloc: L.icon({ 
                iconUrl: 'icons/scrap.png', 
                iconSize: [24, 24], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            scarecrow: L.icon({ 
                iconUrl: 'icons/scarecrow.png', 
                iconSize: [24, 24], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            "death race start": L.icon({ 
                iconUrl: 'icons/death race.png', 
                iconSize: [24, 24], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            sniper: L.icon({ 
                iconUrl: 'icons/snipertower.png', 
                iconSize: [24, 24], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            balloon: L.icon({ 
                iconUrl: 'icons/vantageoutpost.png', 
                iconSize: [24, 24], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            encounter: L.icon({ 
                iconUrl: 'icons/encounter.png', 
                iconSize: [24, 24], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            minefield: L.icon({ 
                iconUrl: 'icons/minefield.png',
                iconSize: [24, 24], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            "feral man": L.icon({ 
                iconUrl: 'icons/objectivemarker.png', 
                iconSize: [20, 20], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            "magnum opus": L.icon({ 
                iconUrl: 'icons/objectivemarker.png', 
                iconSize: [20, 20], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            "righteous work": L.icon({ 
                iconUrl: 'icons/objectivemarker.png', 
                iconSize: [20, 20], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            "into madness": L.icon({ 
                iconUrl: 'icons/objectivemarker.png', 
                iconSize: [20, 20], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            "wasteland classic": L.icon({ 
                iconUrl: 'icons/objectivemarker.png', 
                iconSize: [20, 20], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            "a piece tougher": L.icon({ 
                iconUrl: 'icons/objectivemarker.png', 
                iconSize: [20, 20], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            "wasteland mission": L.icon({ 
                iconUrl: 'icons/wastelandmission.png',
                iconSize: [20, 20], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
            default: L.icon({ 
                iconUrl: 'icons/weakgate.png',
                iconSize: [20, 20], 
                iconAnchor: [16, 16], 
                popupAnchor: [0, -15] 
            }),
        };

        const CALIBRATION = {
            scale: .5,      
            offsetX: 6650, 
            offsetY: 4600
        };

        let activeFilters = ['all'];
        let activeRegionFilters = ['all'];
        const MISSION_TYPES = [
            "feral man", 
            "magnum opus", 
            "righteous work", 
            "into madness",
            "wasteland classic"
        ];

        function initRegionHUD() {
            const regionList = document.getElementById('region-list');
            
            const uniqueRegions = [...new Set(Object.values(locationLibrary).map(item => item.region))].filter(Boolean);
            uniqueRegions.sort();

            let html = `
                <button onclick="applyRegionFilter('all')" data-region="all" class="hud-btn active-filter">
                    <div class="led"></div> <span>All Territories</span>
                </button>`;

            uniqueRegions.forEach(region => {
                html += `
                    <button onclick="applyRegionFilter('${region}')" data-region="${region}" class="hud-btn">
                        <div class="led"></div> <span>${region}</span>
                    </button>`;
            });

            regionList.innerHTML = html;
        }

        function getFilteredRoute() {
            const startPoint = { id: "MISSION_FM_START", note: "Starting Point" };
            
            const filtered = Object.keys(locationLibrary).filter(id => {
                if (id === "MISSION_FM_START") return false;
                
                const data = locationLibrary[id];
                const typeMatch = activeFilters.includes('all') || activeFilters.includes(data.type) || 
                    (activeFilters.includes('mission') && MISSION_TYPES.includes(data.type));
                const regionMatch = activeRegionFilters.includes('all') || activeRegionFilters.includes(data.region);

                return typeMatch && regionMatch;
            }).map(id => ({ id: id }));

            return [startPoint, ...filtered];
        }

        function applyRegionFilter(region) {
            triggerGlitch();
            
            if (region === 'all') {
                activeRegionFilters = ['all'];
            } else {
                activeRegionFilters = activeRegionFilters.filter(f => f !== 'all');
                if (activeRegionFilters.includes(region)) {
                    activeRegionFilters = activeRegionFilters.filter(f => f !== region);
                } else {
                    activeRegionFilters.push(region);
                }
                if (activeRegionFilters.length === 0) activeRegionFilters = ['all'];
            }

            document.querySelectorAll('#region-list .hud-btn').forEach(btn => {
                const btnReg = btn.getAttribute('data-region');
                activeRegionFilters.includes(btnReg) ? btn.classList.add('active-filter') : btn.classList.remove('active-filter');
            });

            refreshMap();
        }

        let currentActiveIndex = null;
        let activeRoute = [];
        const markers = {};
        let backgroundLine, activeLine;

        const mapSize = 8192;
        const mapBounds = [[0, 0], [mapSize, mapSize]];
        const map = L.map('map', { 
            crs: L.CRS.Simple, 
            minZoom: -5,
            maxZoom: 2,
            zoomSnap: 0.1,
            maxBounds: mapBounds
        });

        let linesLayer = L.layerGroup().addTo(map);
        let linesVisible = true;

        L.imageOverlay('mad_max_full_map.png', mapBounds).addTo(map);

        const TERR_LINE_CALIBRATION = {
            scale: 0.7,
            offsetX: 1330,
            offsetY: 850
        };
        const sw_corner = [
            TERR_LINE_CALIBRATION.offsetY,
            TERR_LINE_CALIBRATION.offsetX
        ];
        const ne_corner = [
            (mapSize * TERR_LINE_CALIBRATION.scale) + TERR_LINE_CALIBRATION.offsetY,
            (mapSize * TERR_LINE_CALIBRATION.scale) + TERR_LINE_CALIBRATION.offsetX
        ]
        const territoryBounds = [sw_corner, ne_corner];

        L.imageOverlay('territory_lines.png', territoryBounds, { 
            interactive: false, 
            opacity: 1
        }).addTo(map);
        map.fitBounds(mapBounds);

        function gameToMap(gx, gy) {
            const x = (gx * CALIBRATION.scale) + CALIBRATION.offsetX;
            const y = (gy * -1 * CALIBRATION.scale) + CALIBRATION.offsetY; 
            return [y, x]; 
        }

        let statsExpanded = true;

        function toggleStats() {
            const content = document.getElementById('stats-content');
            const chevron = document.getElementById('stats-chevron');
            statsExpanded = !statsExpanded;
            
            if (statsExpanded) {
                content.style.maxHeight = "500px";
                content.style.opacity = "1";
                chevron.style.transform = "rotate(0deg)";
            } else {
                content.style.maxHeight = "0px";
                content.style.opacity = "0";
                chevron.style.transform = "rotate(-90deg)";
            }
        }

        function renderRoute() {
            const routeList = document.getElementById('route-list');
            const statsContainer = document.getElementById('stats-container');
            const progressPercentText = document.getElementById('total-progress-percent');
            
            routeList.innerHTML = '';
            const pathPoints = [];
            activeRoute = getFilteredRoute();

            const totals = {};
            activeRoute.forEach(step => {
                if (step.id.endsWith('_START')) return;

                const data = locationLibrary[step.id];
                if (!data) return;
                const cat = MISSION_TYPES.includes(data.type) ? 'mission' : data.type;
                totals[cat] = (totals[cat] || 0) + 1;
            });

            const progress = {};
            const limit = currentActiveIndex !== null ? currentActiveIndex : 0;
            for (let i = 0; i <= limit; i++) {
                const stepId = activeRoute[i]?.id;
                if (!stepId || stepId.endsWith('_START')) continue;

                const data = locationLibrary[stepId];
                const cat = MISSION_TYPES.includes(data.type) ? 'mission' : data.type;
                progress[cat] = (progress[cat] || 0) + 1;
            }

            const currentPercent = Math.round((limit / (activeRoute.length - 1)) * 100) || 0;
            progressPercentText.innerText = `${currentPercent}% COMPLETE`;

            activeRoute.forEach((step, index) => {
                const data = locationLibrary[step.id];
                if (!data) return;
                const coords = gameToMap(data.game_coords.x, data.game_coords.y);
                pathPoints.push(coords);
                addMarker(index, coords, data);

                if (index === 0) return;
                const isActive = currentActiveIndex === index;
                const card = document.createElement('div');
                card.id = `step-${index}`;
                card.className = `p-6 border-b border-white/5 cursor-pointer transition-all hover:bg-zinc-900/50 ${isActive ? 'active-step' : ''}`;
                card.onclick = () => selectStep(index);
                card.innerHTML = `<div class="flex items-start gap-4">
                    <div class="w-8 h-8 rounded bg-zinc-800 flex items-center justify-center text-[10px] font-bold text-orange-500 border border-orange-500/20">${index}</div>
                    <div class="flex-grow min-w-0">
                        <span class="text-[9px] text-orange-500/50 font-black uppercase tracking-widest truncate">${data.type}</span>
                        <h3 class="font-bold text-gray-100 text-lg leading-tight truncate">${data.name}</h3>
                    </div>
                </div>`;
                routeList.appendChild(card);
            });

            const trackable = [
                'mission', 
                'camp', 
                'scavloc', 
                'minefield', 
                'balloon', 
                'sniper', 
                'encounter', 
                'death race start', 
                'scarecrow'
            ];
            
            let statsHtml = '';
            
            trackable.forEach(t => {
                if (totals[t]) {
                    const cur = progress[t] || 0;
                    const tot = totals[t];
                    const perc = (cur / tot) * 100;
                    
                    const dynamicBrightness = 0.5 + (perc / 100) * 0.7;
                    
                    let iconUrl;
                    if (t === 'mission') iconUrl = icons['feral man'].options.iconUrl;
                    else iconUrl = icons[t]?.options.iconUrl || icons.default.options.iconUrl;

                    let label = t;
                    if (t === 'scavloc') label = 'scrap';
                    if (t === 'death race start') label = 'race';
                    
                    statsHtml += `
                        <div class="flex flex-col items-center group">
                            <div class="relative mb-2">
                                <img src="${iconUrl}" 
                                    style="filter: brightness(${dynamicBrightness});"
                                    class="w-10 h-10 object-contain transition-all duration-500 
                                    ${cur === tot ? 'scale-110 drop-shadow-[0_0_8px_#f59e0b]' : ''}">
                                
                                ${cur === tot ? '<div class="absolute inset-0 bg-orange-500/10 blur-xl rounded-full animate-pulse"></div>' : ''}
                            </div>
                            
                            <span class="text-[8px] font-black text-zinc-500 uppercase tracking-widest mb-1">${label}</span>
                            <div class="flex items-baseline gap-0.5 mb-2">
                                <span class="text-[10px] font-mono font-black text-white">${cur}</span>
                                <span class="text-[8px] font-mono font-black text-zinc-600">/${tot}</span>
                            </div>

                            <div class="h-1 w-full bg-white/5 rounded-full overflow-hidden border border-white/5">
                                <div class="h-full bg-orange-500 transition-all duration-700 ease-out shadow-[0_0_8px_#f59e0b]" 
                                    style="width: ${perc}%">
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            statsContainer.innerHTML = statsHtml;

            updateLines(pathPoints);
        }

        function addMarker(index, coords, data) {
            const iconToUse = icons[data.type] || icons.default;
            if(!markers[index]) {
                markers[index] = L.marker(coords, { icon: iconToUse }).addTo(map)
                    .bindPopup(`<b class="text-zinc-900">${data.name}</b>`)
                    .on('click', () => selectStep(index));
            } else {
                markers[index].setLatLng(coords);
            }
        }

        let backgroundArrows, activeArrows; 

        function updateLines(pathPoints) {
            linesLayer.clearLayers();

            backgroundLine = L.polyline(pathPoints, {
                color: '#000000',
                weight: 2,
                opacity: 0.4,
                dashArray: '2, 8',
                interactive: false 
            });

            linesLayer.addLayer(backgroundLine);

            /*backgroundArrows = L.polylineDecorator(backgroundLine, {
                patterns: [
                    {
                        offset: 20,
                        repeat: 120,
                        symbol: L.Symbol.arrowHead({
                            pixelSize: 8,
                            polygon: false,
                            pathOptions: { stroke: true, color: '#000000', weight: 1, opacity: 0.7 }
                        })
                    }
                ]
            }).addTo(map);*/

            if (currentActiveIndex !== null && currentActiveIndex > 0) {
                const legPoints = [pathPoints[currentActiveIndex - 1], pathPoints[currentActiveIndex]];
                const currentStep = activeRoute[currentActiveIndex];

                if (!currentStep.fastTravel) {
                    activeLine = L.polyline(legPoints, {
                        color: '#f59e0b', 
                        weight: 6, 
                        opacity: 1, 
                        lineCap: 'round'
                    });
                    linesLayer.addLayer(activeLine);

                    activeArrows = L.polylineDecorator(activeLine, {
                        patterns: [
                            {
                                offset: '20%',
                                repeat: 120,
                                symbol: L.Symbol.arrowHead({
                                    pixelSize: 16,
                                    polygon: true,
                                    pathOptions: {
                                        fillOpacity: 0.3,
                                        color: '#000000',
                                        stroke: false
                                    }
                                })
                            }
                        ]
                    });
                    linesLayer.addLayer(activeArrows);
                }
            }
        }

        function toggleLines() {
            const btn = document.getElementById('line-toggle-btn');
            if (linesVisible) {
                map.removeLayer(linesLayer);
                btn.innerText = "Show Overlay";
                btn.classList.add('border-gray-500', 'text-gray-500');
                btn.classList.remove('border-orange-500/50', 'text-orange-500');
            } else {
                map.addLayer(linesLayer);
                btn.innerText = "Hide Overlay";
                btn.classList.remove('border-gray-500', 'text-gray-500');
                btn.classList.add('border-orange-500/50', 'text-orange-500');
            }
            linesVisible = !linesVisible;
        }

        function selectStep(index) {
            currentActiveIndex = index;
            
            const data = locationLibrary[activeRoute[index].id];
            const prevData = locationLibrary[activeRoute[index - 1].id];
            
            if (!data || !prevData) return;

            const targetCoords = gameToMap(data.game_coords.x, data.game_coords.y);
            const startCoords = gameToMap(prevData.game_coords.x, prevData.game_coords.y);
            
            const legBounds = L.latLngBounds([startCoords, targetCoords]);
            
            map.flyToBounds(legBounds, { 
                padding: [100, 100], 
                duration: 1.2,
                maxZoom: 0
            });

            renderRoute();
            
            const card = document.getElementById(`step-${index}`);
            if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            if (markers[index]) markers[index].openPopup();
        }

        function triggerGlitch() {
            const hud = document.getElementById('filter-hud');
            hud.classList.add('glitch-active');
            setTimeout(() => hud.classList.remove('glitch-active'), 100);
        }

        function applyFilter(type) {
            triggerGlitch();
            if (type === 'all') {
                activeFilters = ['all'];
            } else {
                activeFilters = activeFilters.filter(f => f !== 'all');
                if (activeFilters.includes(type)) {
                    activeFilters = activeFilters.filter(f => f !== type);
                } else {
                    activeFilters.push(type);
                }
                if (activeFilters.length === 0) activeFilters = ['all'];
            }

            document.querySelectorAll('.hud-btn').forEach(btn => {
                const btnType = btn.getAttribute('data-type');
                if (activeFilters.includes(btnType)) {
                    btn.classList.add('active-filter');
                } else {
                    btn.classList.remove('active-filter');
                }
            });

            Object.values(markers).forEach(m => map.removeLayer(m));
            for (let key in markers) delete markers[key];
            currentActiveIndex = null;
            renderRoute();
        }

        function refreshMap() {
            Object.values(markers).forEach(m => map.removeLayer(m));
            for (let key in markers) delete markers[key];
            currentActiveIndex = null;
            renderRoute();
        }

        initRegionHUD();
        renderRoute();
    </script>
</body>
</html>